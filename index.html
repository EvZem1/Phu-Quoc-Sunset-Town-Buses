<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sunset Town Bus</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SunCalc -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes ping-slow {
            75%, 100% { transform: scale(2); opacity: 0; }
        }
        .animate-ping-slow {
            animation: ping-slow 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        /* --- WEATHER ANIMATIONS --- */
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        .star {
            position: absolute; background: white; border-radius: 50%;
            animation: twinkle var(--duration) infinite ease-in-out; animation-delay: var(--delay);
        }

        @keyframes floatCloud {
            from { transform: translateX(-300px); } 
            to { transform: translateX(150vw); } 
        }
        .cloud-container { position: absolute; left: 0; will-change: transform; }

        @keyframes rainFall {
            0% { transform: translateY(-50px) translateX(0); }
            100% { transform: translateY(110vh) translateX(var(--wind-x, 10px)); }
        }
        .raindrop {
            position: absolute; background-color: rgba(255, 255, 255, 0.6); top: -50px;
            width: 1px; height: 15px; animation: rainFall linear infinite; will-change: transform; pointer-events: none;
        }

        @keyframes snowFall {
            0% { transform: translateY(-20px) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(110vh) translateX(var(--wind-x, 20px)); opacity: 0.9; }
        }
        .snowflake {
            position: absolute; background-color: white; border-radius: 50%; top: -20px;
            width: 5px; height: 5px; animation: snowFall linear infinite; will-change: transform;
            box-shadow: 0 0 2px rgba(0,0,0,0.3); pointer-events: none; z-index: 20;
        }

        @keyframes sunGlow {
            from { box-shadow: 0 0 20px -5px rgba(253, 224, 71, 0.5); }
            to { box-shadow: 0 0 50px 10px rgba(253, 224, 71, 0.8); }
        }
        .animate-glow { animation: sunGlow 4s ease-in-out infinite alternate; }

        @keyframes flash {
            0%, 90%, 95%, 100% { opacity: 0; }
            92% { opacity: 0.4; background-color: white; }
            93% { opacity: 0; }
            94% { opacity: 0.2; background-color: white; }
        }
        .lightning-flash { position: absolute; inset: 0; pointer-events: none; z-index: 50; animation: flash 8s infinite; }
        
        .fog-layer {
            position: absolute; bottom: 0; left: 0; right: 0; height: 50vh;
            background: linear-gradient(to top, rgba(255,255,255,0.6), transparent); pointer-events: none; z-index: 20;
        }
        .dark .fog-layer { background: linear-gradient(to top, rgba(148, 163, 184, 0.2), transparent); }
    </style>
</head>
<body class="transition-colors duration-1000 ease-in-out bg-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- TRANSLATIONS ---
        const DICTIONARY = {
            ru: {
                title: "ÐÐ²Ñ‚Ð¾Ð±ÑƒÑÑ‹ Sunset Town",
                beach: "ÐÐ° ÐŸÐ»ÑÐ¶ (Khem)",
                city: "Ð’ Ð“Ð¾Ñ€Ð¾Ð´ (D.Dong)",
                direction: "ÐÐ°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ",
                forward: "Ð¢Ð£Ð”Ð",
                backward: "ÐžÐ‘Ð ÐÐ¢ÐÐž",
                nextBus: "Ð‘Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐ¸Ð¹ Ñ€ÐµÐ¹Ñ",
                nextBusAt: "Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ð°Ð²Ñ‚Ð¾Ð±ÑƒÑ Ð¿Ñ€Ð¸ÐµÐ´ÐµÑ‚ Ð²",
                atStop: "ÐÐ ÐžÐ¡Ð¢ÐÐÐžÐ’ÐšÐ•",
                noBus: "ÐÐ° ÑÐµÐ³Ð¾Ð´Ð½Ñ Ñ€ÐµÐ¹ÑÐ¾Ð² Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½ÐµÑ‚ ðŸ˜´",
                scheduleTitle: "ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ",
                timelineTitle: "ÐšÐ°Ñ€Ñ‚Ð° Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð°",
                swipeHint: "Ð›Ð¸ÑÑ‚Ð°Ð¹Ñ‚Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ Ð²Ð»ÐµÐ²Ð¾-Ð²Ð¿Ñ€Ð°Ð²Ð¾",
                youAreHere: "Ð’Ñ‹ Ð·Ð´ÐµÑÑŒ",
                nearStop: "Ð ÑÐ´Ð¾Ð¼ Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹:",
                meters: "Ð¼",
                km: "ÐºÐ¼",
                sec: "ÑÐµÐº",
                min: "Ð¼Ð¸Ð½",
                hour: "Ñ‡",
                through: "Ñ‡ÐµÑ€ÐµÐ·",
                sky: { night: 'ÐÐ¾Ñ‡ÑŒ ðŸŒ™', dawn: 'Ð£Ñ‚Ñ€Ð¾ ðŸŒ…', day: 'Ð”ÐµÐ½ÑŒ â˜€ï¸', dusk: 'Ð’ÐµÑ‡ÐµÑ€ ðŸŒ‡' },
                viewTable: "Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð°",
                viewMap: "ÐšÐ°Ñ€Ñ‚Ð°"
            },
            en: {
                title: "Sunset Town Bus",
                beach: "To Beach (Khem)",
                city: "To City (D.Dong)",
                direction: "Direction",
                forward: "FORWARD",
                backward: "RETURN",
                nextBus: "Next Bus",
                nextBusAt: "Next bus arrives at",
                atStop: "AT STOP",
                noBus: "No more buses today ðŸ˜´",
                scheduleTitle: "Full Schedule",
                timelineTitle: "Route Map",
                swipeHint: "Swipe table left/right",
                youAreHere: "You are here",
                nearStop: "Near stop:",
                meters: "m",
                km: "km",
                sec: "s",
                min: "m",
                hour: "h",
                through: "in",
                sky: { night: 'Night ðŸŒ™', dawn: 'Morning ðŸŒ…', day: 'Day â˜€ï¸', dusk: 'Evening ðŸŒ‡' },
                viewTable: "Table",
                viewMap: "Map"
            },
            vi: {
                title: "Xe BuÃ½t Sunset Town",
                beach: "Ra BÃ£i Biá»ƒn (Khem)",
                city: "Vá» Thá»‹ Tráº¥n (D.Dong)",
                direction: "HÆ°á»›ng Ä‘i",
                forward: "ÄI",
                backward: "Vá»€",
                nextBus: "Chuyáº¿n tiáº¿p theo",
                nextBusAt: "Xe sáº½ Ä‘áº¿n lÃºc",
                atStop: "ÄANG á»ž TRáº M",
                noBus: "Háº¿t chuyáº¿n hÃ´m nay rá»“i ðŸ˜´",
                scheduleTitle: "Lá»‹ch TrÃ¬nh Chi Tiáº¿t",
                timelineTitle: "Báº£n Äá»“ Tuyáº¿n",
                swipeHint: "Vuá»‘t báº£ng sang trÃ¡i/pháº£i",
                youAreHere: "Báº¡n á»Ÿ Ä‘Ã¢y",
                nearStop: "Gáº§n tráº¡m:",
                meters: "m",
                km: "km",
                sec: "giÃ¢y",
                min: "phÃºt",
                hour: "giá»",
                through: "sau",
                sky: { night: 'ÄÃªm ðŸŒ™', dawn: 'SÃ¡ng ðŸŒ…', day: 'NgÃ y â˜€ï¸', dusk: 'Chiá»u ðŸŒ‡' },
                viewTable: "Báº£ng giá»",
                viewMap: "Báº£n Ä‘á»“"
            }
        };

        // --- DATA ---
        const STOP_COORDINATES = {
            "Khem Beach Station": { lat: 10.0275, lng: 104.0337 }, 
            "New World Resort": { lat: 10.0390, lng: 104.0270 }, 
            "Premier Residences": { lat: 10.0390, lng: 104.0220 },
            "Vui-Fest Bazaar": { default: { lat: 10.03536, lng: 104.00328 } },
            "Sun World Hon Thom": { lat: 10.030187, lng: 104.007234 }, 
            "Sun World": { lat: 10.030187, lng: 104.007234 },
            "Sailing Club": { lat: 10.1450, lng: 103.9750 },
            "Best Western": { lat: 10.1600, lng: 103.9700 },
            "Long Beach Center": { lat: 10.2045, lng: 103.9665 },
            "Seashells Hotel": { lat: 10.2185, lng: 103.9567 }
        };

        const ROUTES = {
            1: {
                id: 1,
                nameRu: "ÐÐ° ÐŸÐ»ÑÐ¶ (Khem Beach)",
                nameEn: "To Khem Beach",
                shortNameRu: "ÐŸÐ»ÑÐ¶ (Khem)",
                shortNameEn: "Beach (Khem)",
                shortNameVi: "BÃ£i Khem",
                icon: "â›±ï¸",
                descRu: "ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ðº Ð¿Ð»ÑÐ¶Ñƒ Khem Beach Ð¸ ÐºÑƒÑ€Ð¾Ñ€Ñ‚Ð°Ð¼",
                descEn: "Route to Khem Beach and resorts",
                descVi: "Tuyáº¿n Ä‘i BÃ£i Khem vÃ  cÃ¡c khu nghá»‰ dÆ°á»¡ng",
                color: "bg-blue-600",
                busImage: "https://www.dropbox.com/scl/fi/3ryvtmwt28oe5b3d9h3ab/Khem-Beach.png?rlkey=c867pgs25uslhdm4oxqkvgbet&st=1j10ebxu&raw=1",
                stopImage: "https://www.dropbox.com/scl/fi/kenyko9101nrb6bcmfx12/.png?rlkey=17fjzjyw1bjngr4uz9fj3f6s3&st=o0elseiz&raw=1",
                stops: {
                    forward: ["Sun World Hon Thom", "Vui-Fest Bazaar", "New World Resort", "Khem Beach Station"],
                    backward: ["Khem Beach Station", "New World Resort", "Vui-Fest Bazaar", "Sun World Hon Thom"]
                },
                schedule: {
                    forward: [
                        ["09:00", "-", "09:15", "09:30"], ["10:00", "-", "10:15", "10:30"], ["11:00", "-", "11:15", "11:30"], ["12:00", "-", "12:15", "12:30"], ["14:00", "-", "14:15", "14:30"], ["15:00", "-", "15:15", "15:30"], ["17:00", "-", "17:15", "17:30"], ["18:00", "18:10", "18:20", "18:30"], ["18:30", "18:40", "18:50", "19:00"], ["19:00", "19:10", "19:20", "19:30"], ["19:30", "19:40", "19:50", "20:00"], ["20:00", "20:10", "20:20", "20:30"], ["20:30", "20:40", "20:50", "21:00"], ["21:00", "21:10", "21:20", "21:30"], ["21:30", "21:40", "21:50", "22:00"]
                    ],
                    backward: [
                        ["08:30", "08:40", "-", "09:00"], ["09:30", "09:40", "-", "10:00"], ["10:30", "10:40", "-", "11:00"], ["11:30", "11:40", "-", "12:00"], ["13:30", "13:40", "-", "14:00"], ["14:30", "14:40", "-", "15:00"], ["16:30", "16:40", "-", "17:00"], ["17:30", "17:40", "17:50", "18:00"], ["18:00", "18:10", "18:20", "18:30"], ["18:30", "18:40", "18:50", "19:00"], ["19:00", "19:10", "19:20", "19:30"], ["19:30", "19:40", "19:50", "20:00"], ["20:00", "20:10", "20:20", "20:30"], ["20:30", "20:40", "20:50", "21:00"], ["21:00", "21:10", "21:20", "21:30"]
                    ]
                }
            },
            2: {
                id: 2,
                nameRu: "Ð’ Ð“Ð¾Ñ€Ð¾Ð´ (Duong Dong)",
                nameEn: "To City (Duong Dong)",
                shortNameRu: "Ð“Ð¾Ñ€Ð¾Ð´ (D.Dong)",
                shortNameEn: "City (D.Dong)",
                shortNameVi: "DÆ°Æ¡ng ÄÃ´ng",
                icon: "ðŸ›–",
                descRu: "ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð² Ñ†ÐµÐ½Ñ‚Ñ€ Ð³Ð¾Ñ€Ð¾Ð´Ð° (Duong Dong)",
                descEn: "Route to city center (Duong Dong)",
                descVi: "Tuyáº¿n Ä‘i trung tÃ¢m thá»‹ tráº¥n DÆ°Æ¡ng ÄÃ´ng",
                color: "bg-teal-600",
                busImage: "https://www.dropbox.com/scl/fi/7mnpx6rei8ijv616ntytg/Duong-Dong.png?rlkey=mxosd9i13twbq275israfxnfk&st=i91vp524&raw=1",
                stopImage: "https://www.dropbox.com/scl/fi/k2t5n19o2a4qakicj73if/.png?rlkey=jte23xtgjulbylynyv92l2xbw&st=4992qh60&raw=1",
                stops: {
                    forward: ["Premier Residences", "Sun World", "Vui-Fest Bazaar", "Sailing Club", "Best Western", "Long Beach Center", "Seashells Hotel"],
                    backward: ["Seashells Hotel", "Long Beach Center", "Best Western", "Sailing Club", "Vui-Fest Bazaar", "Sun World", "Premier Residences"]
                },
                schedule: {
                    forward: [
                        ["07:30", "-", "-", "-", "-", "-", "08:00"], ["08:00", "-", "-", "-", "-", "-", "08:30"], ["09:30", "09:40", "-", "09:55", "10:05", "10:20", "10:30"], ["10:00", "10:10", "-", "10:25", "10:35", "10:50", "11:00"], ["14:00", "14:10", "-", "14:25", "14:35", "14:50", "15:00"], ["14:30", "14:40", "-", "14:55", "15:05", "15:20", "15:30"], ["18:00", "-", "18:10", "18:25", "18:35", "18:50", "19:00"], ["18:30", "-", "18:40", "18:55", "19:05", "19:20", "19:30"], ["-", "-", "21:45", "22:00", "22:10", "22:25", "22:35"]
                    ],
                    backward: [
                        ["08:15", "08:25", "08:40", "08:50", "-", "09:05", "09:15"], ["08:45", "08:55", "09:10", "09:20", "-", "09:35", "09:45"], ["10:45", "10:55", "11:10", "11:20", "-", "11:35", "11:45"], ["11:15", "11:25", "11:40", "11:50", "-", "12:05", "12:15"], ["15:15", "15:25", "15:40", "15:50", "-", "16:05", "16:15"], ["15:45", "15:55", "16:10", "16:20", "-", "16:35", "16:45"], ["19:15", "19:25", "19:40", "19:50", "20:05", "-", "20:15"], ["19:45", "19:55", "20:10", "20:20", "20:35", "-", "20:45"]
                    ]
                }
            }
        };

        // --- UTILS ---
        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };
        const formatDistance = (km, lang) => km < 1 ? `${Math.round(km * 1000)} ${DICTIONARY[lang].meters}` : `${km.toFixed(1)} ${DICTIONARY[lang].km}`;
        const getMinutes = (timeStr) => { if (!timeStr || timeStr === "-") return -1; const [h, m] = timeStr.split(':').map(Number); return h * 60 + m; };
        const getCurrentMinutesFloat = () => { const now = new Date(); return now.getHours() * 60 + now.getMinutes() + now.getSeconds()/60; };
        const getCurrentMinutes = () => { const now = new Date(); return now.getHours() * 60 + now.getMinutes(); };
        const isPast = (timeStr, currentMins) => { const mins = getMinutes(timeStr); return mins !== -1 && mins < Math.floor(currentMins); };
        const formatTimeLeft = (seconds, lang) => {
             const t = DICTIONARY[lang];
             if (seconds <= 0) return `0 ${t.sec}`;
             if (seconds < 60) return `${t.through} ${seconds} ${t.sec}`;
             const diffMins = Math.ceil(seconds / 60);
             if (diffMins < 60) return `${t.through} ${diffMins} ${t.min}`;
             const h = Math.floor(diffMins / 60);
             const m = diffMins % 60;
             return `${t.through} ${h} ${t.hour} ${m} ${t.min}`;
        };

        // --- ICONS ---
        const HeaderBusIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path d="M18 11.0056C17.9972 10.8711 17.9861 10.7389 17.9611 10.6083C17.6583 9.06667 16.3278 7.91389 14.7139 7.82222L14.6556 7.82222H9.36667L9.27778 7.825C7.68056 7.925 6.36389 9.07222 6.05 10.5972C6.01667 10.7417 5.99722 10.8889 5.99444 11.0361C5.99444 11.0389 5.99444 11.0417 5.99444 11.0417V15.7639C5.99444 16.5917 6.66667 17.2639 7.49444 17.2639H7.66944C7.81944 17.2639 7.96111 17.225 8.08889 17.1528C8.24167 17.5194 8.60556 17.7778 9.02778 17.7778C9.53611 17.7778 9.96111 17.4167 10.0639 16.9361H13.9167C14.0222 17.4194 14.4444 17.7778 14.9528 17.7778C15.375 17.7778 15.7361 17.5194 15.8917 17.1556C16.0222 17.225 16.1667 17.2639 16.3194 17.2639H16.4944C17.3222 17.2639 17.9944 16.5917 17.9944 15.7639V11.0389C18 11.025 18 11.0139 18 11.0056ZM9.02778 16.7361C8.74167 16.7361 8.51111 16.5056 8.51111 16.2194C8.51111 15.9333 8.74167 15.7028 9.02778 15.7028C9.31389 15.7028 9.54444 15.9333 9.54444 16.2194C9.54444 16.5056 9.31389 16.7361 9.02778 16.7361ZM14.9528 16.7361C14.6667 16.7361 14.4361 16.5056 14.4361 16.2194C14.4361 15.9333 14.6667 15.7028 14.9528 15.7028C15.2389 15.7028 15.4694 15.9333 15.4694 16.2194C15.4694 16.5056 15.2389 16.7361 14.9528 16.7361ZM16.4861 13.9028H7.50556V11.2361C7.54444 10.3389 8.35833 9.53333 9.36667 9.53333H14.6444C15.65 9.53333 16.4639 10.3306 16.4861 11.2333V13.9028Z" /></svg>);
        const ArrowIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M21 12H3" /><path d="M17 8l4 4-4 4" /></svg>);
        const ClockIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>);
        const InfoIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></svg>);
        const HourglassIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 22h14" /><path d="M5 2h14" /><path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22" /><path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2" /></svg>);
        const LocationIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></svg>);
        const GlobeIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>);
        const MapIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>);
        const TableIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="12" y1="3" x2="12" y2="21"></line></svg>);

        // --- COMPONENTS ---
        
        const SkyBackground = ({ skyState, moonPhase, weatherState, windSpeed, stableLocation }) => {
            const [celestialPos, setCelestialPos] = useState({ x: -20, y: -20 });

            useEffect(() => {
                const calculatePosition = () => {
                    const now = new Date();
                    let progress = 0; let startTime, endTime;
                    if (stableLocation && typeof SunCalc !== 'undefined') {
                        const times = SunCalc.getTimes(now, stableLocation.lat, stableLocation.lng);
                        if (skyState === 'day' || skyState === 'dawn' || skyState === 'dusk') { startTime = times.dawn; endTime = times.dusk; } 
                        else { startTime = times.night; if (now.getHours() > 12) { const t = new Date(now); t.setDate(t.getDate()+1); endTime = SunCalc.getTimes(t, stableLocation.lat, stableLocation.lng).dawn; } else { const y = new Date(now); y.setDate(y.getDate()-1); startTime = SunCalc.getTimes(y, stableLocation.lat, stableLocation.lng).night; endTime = times.dawn; } }
                    } else {
                        const nowMins = now.getHours() * 60 + now.getMinutes();
                        if (skyState !== 'night') progress = (nowMins - 360) / (1080 - 360);
                        else { if (nowMins >= 1080) progress = (nowMins - 1080) / (360 + 1440 - 1080); else progress = (nowMins + (1440 - 1080)) / (360 + 1440 - 1080); }
                    }
                    if (startTime && endTime) { progress = (now - startTime) / (endTime - startTime); }
                    progress = Math.max(0, Math.min(1, progress));
                    setCelestialPos({ x: progress * 100, y: 85 - (Math.sin(progress * Math.PI) * 75) });
                };
                calculatePosition();
                const interval = setInterval(calculatePosition, 60000); 
                return () => clearInterval(interval);
            }, [skyState, stableLocation]);

            const stars = useMemo(() => skyState !== 'night' || weatherState.isOvercast ? [] : Array.from({ length: 35 }).map(() => ({ top: Math.random() * 70 + '%', left: Math.random() * 100 + '%', size: Math.random() * 2 + 1 + 'px', delay: Math.random() * 3 + 's', duration: Math.random() * 3 + 2 + 's' })), [skyState, weatherState.isOvercast]);
            const gradients = { night: 'bg-gradient-to-b from-slate-950 via-slate-900 to-indigo-950', dawn: 'bg-gradient-to-b from-indigo-400 via-purple-300 to-orange-200', day: 'bg-gradient-to-b from-sky-400 to-blue-200', dusk: 'bg-gradient-to-b from-indigo-900 via-purple-800 to-orange-500' };
            const weatherOverlay = weatherState.isOvercast || weatherState.isRainy ? 'after:content-[""] after:absolute after:inset-0 after:bg-slate-900/30' : (weatherState.isFog ? 'after:content-[""] after:absolute after:inset-0 after:bg-white/20 dark:after:bg-slate-500/20 after:backdrop-blur-[2px]' : '');
            
            const rainDrops = useMemo(() => !weatherState.isRainy ? [] : Array.from({ length: weatherState.isHeavyRain ? 120 : (weatherState.isDrizzle ? 40 : 80) }).map(() => ({ left: Math.random() * 100 + '%', animationDuration: (0.5 + Math.random() * 0.3) / (weatherState.isHeavyRain ? 1.5 : 1) + 's', animationDelay: (Math.random() * 2) + 's', windX: (windSpeed ? windSpeed * 2 : 0) + 'px' })), [weatherState.isRainy, windSpeed]);
            const snowflakes = useMemo(() => !weatherState.isSnowy ? [] : Array.from({length: 40}).map(() => ({ left: Math.random() * 100 + '%', animationDuration: (3 + Math.random() * 2) + 's', animationDelay: -(Math.random() * 5) + 's', opacity: 0.8 + Math.random() * 0.2, windX: (windSpeed ? windSpeed * 5 : 10) + 'px' })), [weatherState.isSnowy, windSpeed]);
            const clouds = useMemo(() => {
                const show = weatherState.isOvercast || weatherState.isPartlyCloudy || weatherState.isRainy || weatherState.isSnowy;
                if (!show) return [];
                return Array.from({length: weatherState.isOvercast ? 12 : 5}).map(() => ({
                    top: (Math.random() * 40 + 10) + '%', scale: (0.5 + Math.random()) * 1.5, opacity: 0.6 + Math.random() * 0.2, duration: (30 + Math.random() * 40) + 's', delay: -(Math.random() * 60) + 's'
                }));
            }, [weatherState]);

            return (
                <div className={`absolute inset-0 overflow-hidden -z-0 transition-all duration-1000 ${gradients[skyState] || gradients.day} ${weatherOverlay}`}>
                    {stars.map((s, i) => <div key={i} className="star" style={{ top: s.top, left: s.left, width: s.size, height: s.size, '--delay': s.delay, '--duration': s.duration }} />)}
                    {!weatherState.isOvercast && !weatherState.isHeavyRain && (
                        <div className="absolute w-16 h-16 transition-all duration-[60000ms] ease-linear" style={{ left: `calc(${celestialPos.x}% - 2rem)`, top: `calc(${celestialPos.y}% - 2rem)` }}>
                            {skyState === 'night' ? <svg viewBox="0 0 100 100" className="drop-shadow-[0_0_15px_rgba(255,255,255,0.6)]"><circle cx="50" cy="50" r="40" fill="#fbbf24" opacity={0.9} /><path d="M50 10 A40 40 0 1 0 50 90 A 30 40 0 1 1 50 10" fill="#fef3c7" /></svg> : <div className="w-full h-full rounded-full bg-yellow-300 blur-md shadow-[0_0_40px_rgba(253,224,71,0.8)] animate-glow"></div>}
                        </div>
                    )}
                    {clouds.map((c, i) => (<div key={i} className="absolute cloud-container" style={{ top: c.top, animation: `floatCloud ${c.duration} linear infinite`, animationDelay: c.delay, opacity: c.opacity }}><div className="cloud-scaler" style={{ transform: `scale(${c.scale})` }}><svg viewBox="0 0 120 70" style={{ fill: 'rgba(255,255,255,0.7)', width: 150, height: 80 }}><circle cx="30" cy="40" r="25" /><circle cx="60" cy="35" r="30" /><circle cx="90" cy="40" r="25" /><rect x="30" y="40" width="60" height="25" /></svg></div></div>))}
                    {weatherState.isRainy && rainDrops.map((r, i) => <div key={i} className="raindrop" style={{ left: r.left, animationDuration: r.animationDuration, animationDelay: r.animationDelay, '--wind-x': r.windX }} />)}
                    {weatherState.isSnowy && snowflakes.map((s, i) => <div key={i} className="snowflake" style={{ left: s.left, animationDuration: s.animationDuration, animationDelay: s.animationDelay, opacity: s.opacity, '--wind-x': s.windX }} />)}
                    {weatherState.isStorm && <div className="lightning-flash"></div>}
                    {weatherState.isFog && <div className="fog-layer"></div>}
                </div>
            );
        };

        const Header = ({ activeRoute, setActiveRoute, skyState, weatherState, lang, setLang }) => {
            const t = DICTIONARY[lang];
            const getLangFlag = (l) => l === 'ru' ? 'ðŸ‡·ðŸ‡º RU' : (l === 'en' ? 'ðŸ‡ºðŸ‡¸ EN' : 'ðŸ‡»ðŸ‡³ VI');
            const cycleLang = () => setLang(l => l === 'ru' ? 'en' : (l === 'en' ? 'vi' : 'ru'));

            return (
                <div className="sticky top-0 z-40 bg-transparent">
                    <div className="relative text-white p-4 pb-4 rounded-b-3xl shadow-lg overflow-hidden">
                        <SkyBackground skyState={skyState} weatherState={weatherState} stableLocation={{lat: 10.0, lng: 104.0}} />
                        <div className="relative z-10">
                            <div className="flex justify-between items-start mb-4">
                                <h1 className="text-xl font-bold flex items-center gap-2 drop-shadow-md">
                                    <HeaderBusIcon className="w-6 h-6 text-yellow-300 drop-shadow-sm" /><span>{t.title}</span>
                                </h1>
                                <button onClick={cycleLang} className="flex items-center gap-1 bg-black/20 backdrop-blur-md px-3 py-1 rounded-full border border-white/20 text-xs font-bold uppercase transition-transform active:scale-95 min-w-[70px] justify-center">
                                    {getLangFlag(lang)}
                                </button>
                            </div>
                            <div className="flex bg-white/20 backdrop-blur-md rounded-xl p-1 gap-1 border border-white/10 shadow-inner">
                                {Object.keys(ROUTES).map(id => {
                                    const route = ROUTES[id];
                                    const isActive = activeRoute === Number(id);
                                    let rName = route.shortNameRu;
                                    if(lang === 'en') rName = route.shortNameEn;
                                    if(lang === 'vi') rName = route.shortNameVi;

                                    return <button key={id} onClick={() => setActiveRoute(Number(id))} className={`flex-1 py-3 px-1 text-sm font-bold rounded-lg transition-all flex items-center justify-center gap-2 ${isActive ? 'bg-yellow-400 text-slate-900 shadow-md transform scale-[1.02]' : 'text-white hover:bg-white/10'}`}><span className={isActive ? 'text-slate-900' : 'text-white'}>{route.icon}</span><span>{rName}</span></button>;
                                })}
                            </div>
                            <div className="mt-3 text-center text-white/90 text-xs font-medium drop-shadow-md">{lang === 'ru' ? ROUTES[activeRoute].descRu : (lang === 'vi' ? ROUTES[activeRoute].descVi : ROUTES[activeRoute].descEn)}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const NextBus = ({ schedule, currentMins, userStops, now, activeRouteData, lang }) => {
            const t = DICTIONARY[lang];
            let targetStop = null, displayTime = null, timeUntilSeconds = 0, isAtStop = false;
            
            const findBus = () => {
                if (userStops && userStops.length > 0) {
                    for (const stop of userStops) {
                        const row = schedule.find(r => { const m = getMinutes(r[stop.index]); return m >= Math.floor(currentMins); });
                        if (row) return { stop, time: row[stop.index] };
                    }
                } else {
                    const row = schedule.find(r => { const first = r.find(x => x !== "-"); return first && getMinutes(first) >= Math.floor(currentMins); });
                    if (row) {
                        const idx = row.findIndex(x => x !== "-");
                        return { stop: null, time: row[idx] }; 
                    }
                }
                return null;
            };

            const result = findBus();
            if (result) {
                targetStop = result.stop;
                displayTime = result.time;
                const [h, m] = displayTime.split(':').map(Number);
                const targetDate = new Date(now);
                targetDate.setHours(h, m, 0, 0);
                timeUntilSeconds = Math.floor((targetDate - now) / 1000);
                if (timeUntilSeconds <= 0 && timeUntilSeconds > -60) isAtStop = true;
            }

            if (!displayTime && !isAtStop) return <div className="mx-4 mt-4 p-5 bg-slate-100/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl text-center text-slate-500 dark:text-slate-400 text-sm font-medium backdrop-blur-sm">{t.noBus}</div>;

            const bgClass = isAtStop ? 'from-rose-500 to-pink-600 animate-pulse-fast' : (timeUntilSeconds/60 >= 20 ? 'from-emerald-500 to-teal-700' : (timeUntilSeconds/60 >= 5 ? 'from-yellow-500 to-amber-600' : 'from-orange-500 to-red-600'));

            return (
                <div className={`mx-4 mt-4 bg-gradient-to-br ${bgClass} rounded-2xl p-5 text-white shadow-lg flex flex-col relative overflow-hidden transition-all duration-500 ring-1 ring-white/20`}>
                    <div className="flex justify-between items-center relative z-10 w-full h-full">
                         {isAtStop ? (
                            <div className="flex items-center justify-between w-full py-1">
                                <div className="flex flex-col items-start">
                                    <div className="text-3xl font-black uppercase tracking-tight leading-none mb-1 flex items-center gap-2 drop-shadow-md">BUS</div>
                                    <div className="text-lg font-bold opacity-90 leading-tight">{t.atStop}</div>
                                    {targetStop && <div className="mt-2 text-xs font-medium opacity-80 bg-black/20 px-3 py-1 rounded-full">{targetStop.name}</div>}
                                </div>
                                <div className="relative w-24 h-24 shrink-0 ml-2">
                                     <div className="absolute inset-0 bg-white/20 rounded-full animate-ping-slow"></div>
                                     <img src={activeRouteData.stopImage} className="w-full h-full object-cover rounded-full border-4 border-white/30 shadow-lg relative z-10" />
                                </div>
                            </div>
                        ) : (
                        <>
                             <div>
                                {targetStop ? (
                                    <div className="mb-3">
                                        <div className="flex items-center gap-1.5 text-white font-bold text-sm mb-1">
                                            <div className="flex items-center gap-1 drop-shadow-sm bg-black/20 px-2 py-1 rounded-lg backdrop-blur-md">
                                                <span>{targetStop.name} ({formatDistance(targetStop.dist, lang)})</span>
                                            </div>
                                        </div>
                                        <div className="text-white text-xs opacity-90 font-medium ml-1">{t.nextBusAt}</div>
                                    </div>
                                ) : ( <div className="text-white text-xs font-bold uppercase tracking-wider mb-1">{t.nextBus}</div> )}
                                <div className="text-5xl font-extrabold tracking-tight leading-none mb-1 drop-shadow-md">{displayTime}</div>
                                <div className="inline-flex items-center gap-1.5 bg-white/20 backdrop-blur-md px-3 py-1 rounded-full text-xs font-medium text-white mt-2 shadow-sm border border-white/10"><HourglassIcon className="w-3 h-3" />{formatTimeLeft(timeUntilSeconds, lang)}</div>
                            </div>
                            <div className="p-3 bg-white/10 rounded-full backdrop-blur-md border border-white/10 shadow-inner"><ClockIcon className="w-8 h-8 text-white" /></div>
                        </>
                        )}
                    </div>
                </div>
            );
        };

        // --- NEW GEOMAP COMPONENT ---
        const SchematicMap = ({ stops, activeBus, busImage, userLocation, activeRouteId, direction }) => {
            const svgRef = useRef(null);
            
            // 1. Get Coordinates for current stops
            const stopsWithCoords = useMemo(() => {
                return stops.map(stopName => {
                    const key = Object.keys(STOP_COORDINATES).find(k => stopName.includes(k));
                    let coords = STOP_COORDINATES[key];
                    if (coords && coords.forward && coords.backward) {
                         // Logic from App component to get correct coords for route 2 specific directions
                         coords = activeRouteId === 2 ? (direction === 'forward' ? coords.backward : coords.forward) : coords[direction] || coords.default;
                    } else if (coords && coords.default) {
                        coords = coords.default;
                    }
                    return { name: stopName, ...coords };
                });
            }, [stops, activeRouteId, direction]);

            // 2. Projection Logic
            // Find min/max to create bounding box, then normalize
            const padding = 0.005; // degrees padding
            const lats = stopsWithCoords.map(s => s.lat);
            const lngs = stopsWithCoords.map(s => s.lng);
            const minLat = Math.min(...lats) - padding;
            const maxLat = Math.max(...lats) + padding;
            const minLng = Math.min(...lngs) - padding;
            const maxLng = Math.max(...lngs) + padding;

            const project = (lat, lng) => {
                const x = ((lng - minLng) / (maxLng - minLng)) * 100;
                // SVG Y goes down, Lat goes up. So invert Y.
                const y = 100 - ((lat - minLat) / (maxLat - minLat)) * 100; 
                return { x, y };
            };

            // 3. Build SVG Path
            const points = stopsWithCoords.map(s => project(s.lat, s.lng));
            const pathData = points.map((p, i) => (i === 0 ? `M ${p.x} ${p.y}` : `L ${p.x} ${p.y}`)).join(" ");

            // 4. Calculate Bus Position
            let busPos = { x: -10, y: -10 };
            if (activeBus && !activeBus.isStationary) {
                const start = points[activeBus.stopIndex];
                const end = points[activeBus.stopIndex + 1];
                if (start && end) {
                    busPos.x = start.x + (end.x - start.x) * activeBus.progress;
                    busPos.y = start.y + (end.y - start.y) * activeBus.progress;
                }
            } else if (activeBus && activeBus.isStationary) {
                busPos = points[activeBus.stopIndex];
            }

            // 5. User Position
            let userPos = null;
            if (userLocation) {
                userPos = project(userLocation.lat, userLocation.lng);
                // Clamp to view
                if(userPos.x < 0 || userPos.x > 100 || userPos.y < 0 || userPos.y > 100) userPos = null; // Only show if inside map view roughly
                else userPos = project(userLocation.lat, userLocation.lng);
            }

            return (
                <div className="w-full h-80 bg-slate-100 dark:bg-slate-800 rounded-xl relative overflow-hidden border border-slate-200 dark:border-slate-700 shadow-inner">
                    <svg viewBox="0 0 100 100" className="w-full h-full p-4" preserveAspectRatio="xMidYMid meet">
                        {/* Connecting Line */}
                        <path d={pathData} fill="none" stroke="currentColor" className="text-slate-300 dark:text-slate-600" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" />
                        
                        {/* Stops */}
                        {points.map((p, i) => (
                            <g key={i}>
                                <circle cx={p.x} cy={p.y} r="3" className="fill-white dark:fill-slate-800 stroke-slate-400 dark:stroke-slate-500 stroke-[1.5]" />
                            </g>
                        ))}
                        
                        {/* User Location */}
                        {userPos && (
                            <g transform={`translate(${userPos.x}, ${userPos.y})`}>
                                <circle r="4" className="fill-blue-500/30 animate-ping" />
                                <circle r="2" className="fill-blue-500 stroke-white stroke-1" />
                            </g>
                        )}

                        {/* Bus */}
                        {activeBus && (
                            <g transform={`translate(${busPos.x}, ${busPos.y})`} className="transition-all duration-1000 ease-linear">
                                <circle r="5" className="fill-yellow-400 shadow-sm" />
                                <image href={busImage} x="-4" y="-4" height="8" width="8" />
                            </g>
                        )}
                    </svg>

                    {/* Labels overlay (HTML for better text rendering) */}
                    {points.map((p, i) => (
                         <div key={i} className="absolute text-[8px] font-bold text-slate-600 dark:text-slate-300 bg-white/80 dark:bg-slate-900/80 px-1 rounded backdrop-blur-sm pointer-events-none whitespace-nowrap" 
                              style={{ left: `${p.x}%`, top: `${p.y}%`, transform: 'translate(-50%, 10px)' }}>
                             {stopsWithCoords[i].name.split(' ')[0]}
                         </div>
                    ))}
                    
                    <div className="absolute bottom-2 right-2 text-[8px] text-slate-400">Map Scale: Auto</div>
                </div>
            );
        };

        const ScheduleTable = ({ stops, schedule, currentMins, userStops, busImage, activeBus, lang }) => {
            const t = DICTIONARY[lang];
            const closestStopIndex = userStops && userStops.length > 0 ? userStops[0].index : -1;

            return (
                <div className="overflow-x-auto scrollbar-hide pb-4">
                    <table className="w-full text-sm text-left border-collapse min-w-[600px] md:min-w-full">
                        <thead className="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50/50 dark:bg-slate-800/50 border-y border-slate-200 dark:border-slate-700">
                            <tr>
                                {stops.map((stop, idx) => (
                                    <th key={idx} className={`px-4 py-3 font-bold whitespace-nowrap min-w-[120px] first:pl-6 last:pr-6 ${idx === closestStopIndex ? 'text-blue-600 dark:text-blue-400' : ''}`}>
                                        <div className="flex items-center gap-1">{stop} {idx === closestStopIndex && <LocationIcon className="w-3 h-3" />}</div>
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody>
                            {schedule.map((row, rowIdx) => {
                                const isActiveRow = activeBus && activeBus.rowIndex === rowIdx;
                                let isRowPast = !isActiveRow && row.every(time => time === "-" || isPast(time, currentMins));
                                
                                return (
                                    <tr key={rowIdx} className={`border-b border-slate-100 dark:border-slate-800 ${isRowPast ? 'bg-slate-50/30 dark:bg-slate-900/30 opacity-50' : 'bg-white/80 dark:bg-slate-900/80'} ${isActiveRow ? 'bg-yellow-50/50 dark:bg-yellow-900/20' : ''}`}>
                                        {row.map((time, cellIdx) => {
                                            const showBus = activeBus && activeBus.rowIndex === rowIdx && activeBus.stopIndex === cellIdx;
                                            return (
                                                <td key={cellIdx} className={`px-4 py-3 whitespace-nowrap first:pl-6 last:pr-6 relative ${cellIdx === closestStopIndex ? 'bg-blue-50/30' : ''}`}>
                                                    {showBus && !activeBus.isStationary && (
                                                        <div className="absolute inset-y-0 left-0 w-full flex items-center z-20 pointer-events-none">
                                                            <div className="absolute transition-all duration-1000 ease-linear" style={{ left: `calc(1.5rem + ${activeBus.progress * 80}px)` }}>
                                                                <img src={busImage} alt="Bus" className="h-6 w-auto drop-shadow-md animate-float" />
                                                            </div>
                                                        </div>
                                                    )}
                                                    {time === "-" ? <span className="text-slate-300 font-light">â€”</span> : <span className={`font-mono text-[15px] ${isActiveRow ? 'font-bold text-slate-900 dark:text-white' : ''} ${showBus && activeBus.isStationary ? 'bg-rose-500 text-white px-1 rounded animate-pulse' : ''}`}>{time}</span>}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                    <div className="text-center text-[10px] text-slate-400 mt-2 flex justify-center items-center gap-2"><ArrowIcon className="rotate-90" /><span>{t.swipeHint}</span><ArrowIcon className="-rotate-90" /></div>
                </div>
            );
        };

        const App = () => {
            const [activeRouteId, setActiveRouteId] = useState(1);
            const [direction, setDirection] = useState('forward');
            const [currentMins, setCurrentMins] = useState(getCurrentMinutesFloat());
            const [now, setNow] = useState(new Date());
            const [skyState, setSkyState] = useState('day');
            const [userLocation, setUserLocation] = useState(null);
            const [userStops, setUserStops] = useState(null);
            const [weatherState, setWeatherState] = useState({ isRainy: false, isCloudy: false, isOvercast: false, isPartlyCloudy: true, isDrizzle: false, isHeavyRain: false, isStorm: false, isFog: false, isSnowy: false });
            const [lang, setLang] = useState('ru');
            const [viewMode, setViewMode] = useState('table'); // Default to TABLE now
            
            const t = DICTIONARY[lang];

            // Core Time Loop
            useEffect(() => { const i = setInterval(() => { setCurrentMins(getCurrentMinutesFloat()); setNow(new Date()); }, 1000); return () => clearInterval(i); }, []);
            
            // Theme & Sky Loop
            useEffect(() => {
                const updateTheme = () => {
                    const h = new Date().getHours();
                    let s = (h >= 20 || h < 6) ? 'night' : (h >= 6 && h < 9) ? 'dawn' : (h >= 18 && h < 20) ? 'dusk' : 'day';
                    setSkyState(s);
                    document.documentElement.className = (s === 'night' || s === 'dusk') ? 'dark' : '';
                };
                updateTheme(); setInterval(updateTheme, 60000);
            }, []);

            // Geolocation
            useEffect(() => { if ("geolocation" in navigator) navigator.geolocation.watchPosition(p => setUserLocation({ lat: p.coords.latitude, lng: p.coords.longitude })); }, []);

            // User Stops Calculation
            useEffect(() => {
                if (!userLocation) return;
                const stops = ROUTES[activeRouteId].stops[direction].map((name, idx) => {
                    const k = Object.keys(STOP_COORDINATES).find(key => name.includes(key));
                    if (!k) return null;
                    const coords = STOP_COORDINATES[k].forward && STOP_COORDINATES[k].backward 
                        ? (activeRouteId === 2 ? (direction === 'forward' ? STOP_COORDINATES[k].backward : STOP_COORDINATES[k].forward) : STOP_COORDINATES[k][direction] || STOP_COORDINATES[k].default) 
                        : STOP_COORDINATES[k];
                    return coords ? { name, dist: calculateDistance(userLocation.lat, userLocation.lng, coords.lat, coords.lng), index: idx } : null;
                }).filter(Boolean).sort((a,b) => a.dist - b.dist);
                setUserStops(stops.length && stops[0].dist < 15 ? stops : null);
            }, [userLocation, activeRouteId, direction]);

            useEffect(() => setDirection('forward'), [activeRouteId]);

            const activeData = ROUTES[activeRouteId];
            const currentStops = activeData.stops[direction];
            const currentSchedule = activeData.schedule[direction];

            // Active Bus Calculation (Shared logic)
            let activeBus = null;
            for (let r = 0; r < currentSchedule.length; r++) {
                const row = currentSchedule[r];
                const start = getMinutes(row.find(x => x !== "-"));
                const end = getMinutes([...row].reverse().find(x => x !== "-"));
                if (currentMins >= start && currentMins <= end) {
                    let idx = -1, nextIdx = -1;
                    for (let i = 0; i < row.length; i++) { if (getMinutes(row[i]) !== -1 && getMinutes(row[i]) <= currentMins) idx = i; }
                    if (idx !== -1) {
                         for (let j = idx + 1; j < row.length; j++) { if (getMinutes(row[j]) !== -1) { nextIdx = j; break; } }
                         const isStationary = getMinutes(row[idx]) === Math.floor(currentMins);
                         let progress = 0;
                         if (nextIdx !== -1 && !isStationary) {
                             const total = getMinutes(row[nextIdx]) - getMinutes(row[idx]);
                             progress = (currentMins - getMinutes(row[idx])) / total;
                         }
                         activeBus = { rowIndex: r, stopIndex: idx, progress: Math.min(1, Math.max(0, progress)), isStationary };
                         break;
                    }
                }
            }

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-900 max-w-lg mx-auto shadow-2xl md:my-5 overflow-hidden relative md:rounded-[30px] border-slate-200 dark:border-slate-800 md:border transition-colors duration-500 pb-20">
                    <Header activeRoute={activeRouteId} setActiveRoute={setActiveRouteId} skyState={skyState} weatherState={weatherState} lang={lang} setLang={setLang} />
                    
                    <main>
                        {/* Direction Toggle */}
                        <div className="px-4 mt-4 relative z-10">
                            <button onClick={() => setDirection(direction === 'forward' ? 'backward' : 'forward')} className="w-full flex items-center justify-between p-4 rounded-2xl border bg-white/80 dark:bg-slate-800/80 border-slate-200 dark:border-slate-700 backdrop-blur-sm shadow-sm active:scale-95 transition-all">
                                <div className="flex flex-col items-start"><span className="text-[10px] tracking-wider text-slate-500 font-bold uppercase mb-1">{t.direction}</span><span className="font-bold text-lg text-slate-800 dark:text-slate-100 flex items-center gap-2">{direction === 'forward' ? t.forward : t.backward}</span></div>
                                <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300 font-medium bg-slate-100 dark:bg-slate-700 px-3 py-2 rounded-lg max-w-[50%] overflow-hidden whitespace-nowrap">
                                    <span className="truncate">{currentStops[0].split(' ')[0]}</span><ArrowIcon /><span className="truncate">{currentStops[currentStops.length-1].split(' ')[0]}</span>
                                </div>
                            </button>
                        </div>

                        {userStops && (
                             <div className="mx-4 mt-2 mb-1 flex items-center justify-center gap-2 text-xs text-blue-600 dark:text-blue-400 font-medium bg-blue-50/50 dark:bg-blue-900/20 py-1.5 rounded-lg border border-blue-100 dark:border-blue-800 animate-pulse">
                                <LocationIcon className="w-3 h-3" /><span>{t.youAreHere} <b>{userStops[0].name}</b></span>
                            </div>
                        )}

                        <NextBus schedule={currentSchedule} currentMins={currentMins} userStops={userStops} now={now} activeRouteData={activeData} lang={lang} />

                        {/* View Mode Toggle */}
                        <div className="flex justify-center mt-8 mb-4">
                            <div className="flex bg-slate-200 dark:bg-slate-800 p-1 rounded-lg">
                                <button onClick={() => setViewMode('table')} className={`px-4 py-1.5 rounded-md text-xs font-bold flex items-center gap-2 transition-all ${viewMode === 'table' ? 'bg-white dark:bg-slate-700 shadow text-slate-900 dark:text-white' : 'text-slate-500'}`}><TableIcon /> {t.viewTable}</button>
                                <button onClick={() => setViewMode('map')} className={`px-4 py-1.5 rounded-md text-xs font-bold flex items-center gap-2 transition-all ${viewMode === 'map' ? 'bg-white dark:bg-slate-700 shadow text-slate-900 dark:text-white' : 'text-slate-500'}`}><MapIcon /> {t.viewMap}</button>
                            </div>
                        </div>

                        <div className="border-t border-slate-200 dark:border-slate-800 pt-4 bg-white/50 dark:bg-slate-900/50 min-h-[400px]">
                            <h3 className="px-6 text-xs font-bold text-slate-400 uppercase mb-2 flex items-center gap-2"><InfoIcon /> {viewMode === 'map' ? t.timelineTitle : t.scheduleTitle}</h3>
                            <div className="px-4">
                                {viewMode === 'map' ? 
                                    <SchematicMap stops={currentStops} activeBus={activeBus} busImage={activeData.busImage} userLocation={userLocation} activeRouteId={activeRouteId} direction={direction} /> : 
                                    <ScheduleTable stops={currentStops} schedule={currentSchedule} currentMins={currentMins} userStops={userStops} busImage={activeData.busImage} activeBus={activeBus} lang={lang} />
                                }
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
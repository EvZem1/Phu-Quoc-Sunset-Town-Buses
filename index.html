<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≤—Ç–æ–±—É—Å—ã Sunset Town</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ JSX –≤ –±—Ä–∞—É–∑–µ—Ä–µ -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SunCalc –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å–≤–µ—Ç–æ–≤ –∏ –∑–∞–∫–∞—Ç–æ–≤ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <!-- Tailwind CSS —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π Dark Mode -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    },
                    animation: {
                        'float': 'float linear infinite', 
                        'twinkle': 'twinkle 4s infinite ease-in-out',
                        'glow': 'glow 6s ease-in-out infinite alternate',
                        'rain': 'rain 0.5s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%': { left: '-40%' },   
                            '100%': { left: '140%' }, 
                        },
                        twinkle: {
                            '0%, 100%': { opacity: 0.3, transform: 'scale(0.8)' },
                            '50%': { opacity: 1, transform: 'scale(1.1)' },
                        },
                        glow: {
                            'from': { boxShadow: '0 0 20px -5px rgba(253, 224, 71, 0.5)' },
                            'to': { boxShadow: '0 0 50px 10px rgba(253, 224, 71, 0.8)' }
                        },
                        rain: {
                            '0%': { transform: 'translateY(-10vh)' },
                            '100%': { transform: 'translateY(100vh)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes ping-slow {
            75%, 100% { transform: scale(2); opacity: 0; }
        }
        .animate-ping-slow {
            animation: ping-slow 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        @keyframes bounce-bus {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }
        .animate-bus {
            animation: bounce-bus 0.6s infinite ease-in-out;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) infinite ease-in-out;
            animation-delay: var(--delay);
        }
        
        .cloud-shape {
            /* –¶–≤–µ—Ç –∑–∞–¥–∞–µ—Ç—Å—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ */
        }

        .raindrop {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.6);
            width: 1px;
            height: 15px;
            top: -20px;
            animation: rain linear infinite;
        }
    </style>
</head>
<body class="transition-colors duration-1000 ease-in-out">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- –ö–û–û–†–î–ò–ù–ê–¢–´ –û–°–¢–ê–ù–û–í–û–ö ---
        const STOP_COORDINATES = {
            "Khem Beach Station": { lat: 10.0435, lng: 104.0260 },
            "New World Resort": { lat: 10.0410, lng: 104.0240 },
            "Premier Residences": { lat: 10.0390, lng: 104.0220 },
            "Vui-Fest Bazaar": { lat: 10.0240, lng: 104.0070 },
            "Sun World Hon Thom": { lat: 10.0255, lng: 104.0055 }, 
            "Sun World": { lat: 10.0255, lng: 104.0055 },
            "Sailing Club": { lat: 10.1450, lng: 103.9750 },
            "Best Western": { lat: 10.1550, lng: 103.9720 },
            "Long Beach Center": { lat: 10.1980, lng: 103.9650 },
            "Seashells Hotel": { lat: 10.2160, lng: 103.9560 }
        };

        // --- –ò–ö–û–ù–ö–ò ---
        const HeaderBusIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path d="M18 11.0056C17.9972 10.8711 17.9861 10.7389 17.9611 10.6083C17.6583 9.06667 16.3278 7.91389 14.7139 7.82222L14.6556 7.82222H9.36667L9.27778 7.825C7.68056 7.925 6.36389 9.07222 6.05 10.5972C6.01667 10.7417 5.99722 10.8889 5.99444 11.0361C5.99444 11.0389 5.99444 11.0417 5.99444 11.0417V15.7639C5.99444 16.5917 6.66667 17.2639 7.49444 17.2639H7.66944C7.81944 17.2639 7.96111 17.225 8.08889 17.1528C8.24167 17.5194 8.60556 17.7778 9.02778 17.7778C9.53611 17.7778 9.96111 17.4167 10.0639 16.9361H13.9167C14.0222 17.4194 14.4444 17.7778 14.9528 17.7778C15.375 17.7778 15.7361 17.5194 15.8917 17.1556C16.0222 17.225 16.1667 17.2639 16.3194 17.2639H16.4944C17.3222 17.2639 17.9944 16.5917 17.9944 15.7639V11.0389C18 11.025 18 11.0139 18 11.0056ZM9.02778 16.7361C8.74167 16.7361 8.51111 16.5056 8.51111 16.2194C8.51111 15.9333 8.74167 15.7028 9.02778 15.7028C9.31389 15.7028 9.54444 15.9333 9.54444 16.2194C9.54444 16.5056 9.31389 16.7361 9.02778 16.7361ZM14.9528 16.7361C14.6667 16.7361 14.4361 16.5056 14.4361 16.2194C14.4361 15.9333 14.6667 15.7028 14.9528 15.7028C15.2389 15.7028 15.4694 15.9333 15.4694 16.2194C15.4694 16.5056 15.2389 16.7361 14.9528 16.7361ZM16.4861 13.9028H7.50556V11.2361C7.54444 10.3389 8.35833 9.53333 9.36667 9.53333H14.6444C15.65 9.53333 16.4639 10.3306 16.4861 11.2333V13.9028Z" /></svg>);
        const ArrowIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M21 12H3" /><path d="M17 8l4 4-4 4" /></svg>);
        const ClockIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>);
        const InfoIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></svg>);
        const BeachIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 8c0-2.76-2.46-5-5.5-5S2 5.24 2 8h2c0-1.66 1.57-3 3.5-3S11 6.34 11 8h2z" /><path d="M13 7.14A5.82 5.82 0 0 1 16.5 6c3.04 0 5.5 2.24 5.5 5h-2c0-1.66-1.57-3-3.5-3c-1.25 0-2.34.56-3.03 1.44" /><path d="M12 22v-9" /><path d="M12 13a4 4 0 0 0 4 3" /><path d="M12 13a4 4 0 0 1-4 3" /><path d="M4 22h16" /></svg>);
        const CityIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 22h20" /><path d="M17 22v-6" /><path d="M14 22v-9a2 2 0 0 1 2-2h1" /><path d="M10 22V5a2 2 0 0 1 2-2h1" /><path d="M7 22V9a2 2 0 0 1 2-2h1" /><path d="M4 22v-5a2 2 0 0 1 2-2h1" /></svg>);
        const HourglassIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 22h14" /><path d="M5 2h14" /><path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22" /><path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2" /></svg>);
        const LocationIcon = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></svg>);
        const SunIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-yellow-400"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>);
        const MoonIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-200"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>);

        // --- –î–ê–ù–ù–´–ï –†–ê–°–ü–ò–°–ê–ù–ò–Ø --- (—Ç–æ –∂–µ —Å–∞–º–æ–µ)
        const ROUTES = {
            1: {
                id: 1,
                name: "–ù–∞ –ü–ª—è–∂ (Khem Beach)",
                shortName: "–ü–ª—è–∂ (Khem)",
                icon: <span className="text-lg">‚õ±Ô∏è</span>,
                desc: "–ú–∞—Ä—à—Ä—É—Ç –∫ –ø–ª—è–∂—É Khem Beach –∏ –∫—É—Ä–æ—Ä—Ç–∞–º",
                color: "bg-blue-600",
                busImage: "https://www.dropbox.com/scl/fi/3ryvtmwt28oe5b3d9h3ab/Khem-Beach.png?rlkey=c867pgs25uslhdm4oxqkvgbet&st=1j10ebxu&raw=1",
                stopImage: "https://www.dropbox.com/scl/fi/kenyko9101nrb6bcmfx12/.png?rlkey=17fjzjyw1bjngr4uz9fj3f6s3&st=o0elseiz&raw=1",
                stops: {
                    forward: ["Sun World Hon Thom", "Vui-Fest Bazaar", "New World Resort", "Khem Beach Station"],
                    backward: ["Khem Beach Station", "New World Resort", "Vui-Fest Bazaar", "Sun World Hon Thom"]
                },
                schedule: {
                    forward: [
                        ["09:00", "-", "09:15", "09:30"], ["10:00", "-", "10:15", "10:30"], ["11:00", "-", "11:15", "11:30"], ["12:00", "-", "12:15", "12:30"], ["14:00", "-", "14:15", "14:30"], ["15:00", "-", "15:15", "15:30"], ["17:00", "-", "17:15", "17:30"], ["18:00", "18:10", "18:20", "18:30"], ["18:30", "18:40", "18:50", "19:00"], ["19:00", "19:10", "19:20", "19:30"], ["19:30", "19:40", "19:50", "20:00"], ["20:00", "20:10", "20:20", "20:30"], ["20:30", "20:40", "20:50", "21:00"], ["21:00", "21:10", "21:20", "21:30"], ["21:30", "21:40", "21:50", "22:00"]
                    ],
                    backward: [
                        ["08:30", "08:40", "-", "09:00"], ["09:30", "09:40", "-", "10:00"], ["10:30", "10:40", "-", "11:00"], ["11:30", "11:40", "-", "12:00"], ["13:30", "13:40", "-", "14:00"], ["14:30", "14:40", "-", "15:00"], ["16:30", "16:40", "-", "17:00"], ["17:30", "17:40", "17:50", "18:00"], ["18:00", "18:10", "18:20", "18:30"], ["18:30", "18:40", "18:50", "19:00"], ["19:00", "19:10", "19:20", "19:30"], ["19:30", "19:40", "19:50", "20:00"], ["20:00", "20:10", "20:20", "20:30"], ["20:30", "20:40", "20:50", "21:00"], ["21:00", "21:10", "21:20", "21:30"]
                    ]
                }
            },
            2: {
                id: 2,
                name: "–í –ì–æ—Ä–æ–¥ (Duong Dong)",
                shortName: "–ì–æ—Ä–æ–¥ (D.Dong)",
                icon: <span className="text-lg">üõñ</span>,
                desc: "–ú–∞—Ä—à—Ä—É—Ç –≤ —Ü–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞ (Duong Dong)",
                color: "bg-teal-600",
                busImage: "https://www.dropbox.com/scl/fi/7mnpx6rei8ijv616ntytg/Duong-Dong.png?rlkey=mxosd9i13twbq275israfxnfk&st=i91vp524&raw=1",
                stopImage: "https://www.dropbox.com/scl/fi/k2t5n19o2a4qakicj73if/.png?rlkey=jte23xtgjulbylynyv92l2xbw&st=4992qh60&raw=1",
                stops: {
                    forward: ["Premier Residences", "Sun World", "Vui-Fest Bazaar", "Sailing Club", "Best Western", "Long Beach Center", "Seashells Hotel"],
                    backward: ["Seashells Hotel", "Long Beach Center", "Best Western", "Sailing Club", "Vui-Fest Bazaar", "Sun World", "Premier Residences"]
                },
                schedule: {
                    forward: [
                        ["07:30", "-", "-", "-", "-", "-", "08:00"], ["08:00", "-", "-", "-", "-", "-", "08:30"], ["09:30", "09:40", "-", "09:55", "10:05", "10:20", "10:30"], ["10:00", "10:10", "-", "10:25", "10:35", "10:50", "11:00"], ["14:00", "14:10", "-", "14:25", "14:35", "14:50", "15:00"], ["14:30", "14:40", "-", "14:55", "15:05", "15:20", "15:30"], ["18:00", "-", "18:10", "18:25", "18:35", "18:50", "19:00"], ["18:30", "-", "18:40", "18:55", "19:05", "19:20", "19:30"], ["-", "-", "21:45", "22:00", "22:10", "22:25", "22:35"]
                    ],
                    backward: [
                        ["08:15", "08:25", "08:40", "08:50", "-", "09:05", "09:15"], ["08:45", "08:55", "09:10", "09:20", "-", "09:35", "09:45"], ["10:45", "10:55", "11:10", "11:20", "-", "11:35", "11:45"], ["11:15", "11:25", "11:40", "11:50", "-", "12:05", "12:15"], ["15:15", "15:25", "15:40", "15:50", "-", "16:05", "16:15"], ["15:45", "15:55", "16:10", "16:20", "-", "16:35", "16:45"], ["19:15", "19:25", "19:40", "19:50", "20:05", "-", "20:15"], ["19:45", "19:55", "20:10", "20:20", "20:35", "-", "20:45"]
                    ]
                }
            }
        };

        // --- –£–¢–ò–õ–ò–¢–´ ---
        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };
        const formatDistance = (km) => km < 1 ? `${Math.round(km * 1000)} –º` : `${km.toFixed(1)} –∫–º`;
        const getMinutes = (timeStr) => { if (!timeStr || timeStr === "-") return -1; const [h, m] = timeStr.split(':').map(Number); return h * 60 + m; };
        
        const getCurrentMinutesFloat = () => { const now = new Date(); return now.getHours() * 60 + now.getMinutes() + now.getSeconds()/60; };
        const getCurrentMinutes = () => { const now = new Date(); return now.getHours() * 60 + now.getMinutes(); };
        
        const isPast = (timeStr, currentMins) => { 
            const mins = getMinutes(timeStr); 
            return mins !== -1 && mins < Math.floor(currentMins); 
        };
        
        const formatTimeLeft = (seconds) => {
             if (seconds <= 0) return "0 —Å–µ–∫";
             if (seconds < 60) return `—á–µ—Ä–µ–∑ ${seconds} —Å–µ–∫`;
             const diffMins = Math.ceil(seconds / 60);
             if (diffMins < 60) return `—á–µ—Ä–µ–∑ ${diffMins} –º–∏–Ω`;
             const h = Math.floor(diffMins / 60);
             const m = diffMins % 60;
             return `—á–µ—Ä–µ–∑ ${h} —á ${m} –º–∏–Ω`;
        };

        // --- –ö–û–ú–ü–û–ù–ï–ù–¢ –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ì–û –ù–ï–ë–ê ---
        const SkyBackground = ({ skyState, moonPhase, userLocation, weatherState, windSpeed }) => {
            const [celestialPos, setCelestialPos] = useState({ x: -20, y: -20 });

            useEffect(() => {
                const calculatePosition = () => {
                    const now = new Date();
                    let progress = 0; 
                    let startTime, endTime;
                    
                    if (userLocation && typeof SunCalc !== 'undefined') {
                        const times = SunCalc.getTimes(now, userLocation.lat, userLocation.lng);
                        if (skyState === 'day' || skyState === 'dawn' || skyState === 'dusk') {
                            startTime = times.dawn; 
                            endTime = times.dusk; 
                        } else {
                            if (now.getHours() > 12) {
                                const tomorrow = new Date(now);
                                tomorrow.setDate(tomorrow.getDate() + 1);
                                const tomorrowTimes = SunCalc.getTimes(tomorrow, userLocation.lat, userLocation.lng);
                                // Night: from today's sunset to tomorrow's sunrise
                                startTime = times.sunset; 
                                endTime = tomorrowTimes.sunrise; 
                            } else {
                                const yesterday = new Date(now);
                                yesterday.setDate(yesterday.getDate() - 1);
                                const yesterdayTimes = SunCalc.getTimes(yesterday, userLocation.lat, userLocation.lng);
                                // Night: from yesterday's sunset to today's sunrise
                                startTime = yesterdayTimes.sunset;
                                endTime = times.sunrise; 
                            }
                        }
                    } else {
                        const nowMins = now.getHours() * 60 + now.getMinutes();
                        if (skyState !== 'night') {
                            progress = (nowMins - 360) / (1080 - 360);
                        } else {
                            if (nowMins >= 1080) progress = (nowMins - 1080) / (24*60 + 360 - 1080);
                            else progress = (nowMins + (24*60 - 1080)) / (24*60 + 360 - 1080);
                        }
                    }

                    if (startTime && endTime) {
                        const totalDuration = endTime - startTime;
                        const elapsed = now - startTime;
                        progress = elapsed / totalDuration;
                    }

                    progress = Math.max(0, Math.min(1, progress));
                    const x = progress * 100;
                    // Modified curve to keep it a bit higher
                    const y = 85 - (Math.sin(progress * Math.PI) * 75); 
                    setCelestialPos({ x, y });
                };

                calculatePosition();
                const interval = setInterval(calculatePosition, 60000); 
                return () => clearInterval(interval);
            }, [skyState, userLocation]);

            const stars = useMemo(() => {
                if (skyState !== 'night' || weatherState.isCloudy) return [];
                return Array.from({ length: 35 }).map((_, i) => ({
                    top: Math.random() * 70 + '%',
                    left: Math.random() * 100 + '%',
                    size: Math.random() * 2 + 1 + 'px',
                    delay: Math.random() * 3 + 's',
                    duration: Math.random() * 3 + 2 + 's'
                }));
            }, [skyState, weatherState.isCloudy]);

            const gradients = {
                night: 'bg-gradient-to-b from-slate-950 via-slate-900 to-indigo-950', 
                dawn: 'bg-gradient-to-b from-indigo-400 via-purple-300 to-orange-200', 
                day: 'bg-gradient-to-b from-sky-400 to-blue-200', 
                dusk: 'bg-gradient-to-b from-indigo-900 via-purple-800 to-orange-500', 
            };

            const weatherOverlay = weatherState.isCloudy || weatherState.isRainy ? 'after:content-[""] after:absolute after:inset-0 after:bg-slate-900/30' : '';
            const rainDrops = useMemo(() => {
                if (!weatherState.isRainy) return [];
                return Array.from({ length: 50 }).map((_, i) => ({
                    left: Math.random() * 100 + '%',
                    animationDuration: (0.5 + Math.random() * 0.3) + 's',
                    animationDelay: (Math.random() * 2) + 's'
                }));
            }, [weatherState.isRainy]);

            const clouds = useMemo(() => {
               const showClouds = weatherState.isCloudy || weatherState.isRainy; // STRICT WEATHER LOGIC
               if (!showClouds) return [];

               const count = 8;
               return Array.from({length: count}).map((_, i) => ({
                   top: (Math.random() * 40 + 5) + '%',
                   scale: 0.5 + Math.random(),
                   opacity: (weatherState.isCloudy ? 0.6 : 0.4) + Math.random() * 0.2,
                   duration: (40 + Math.random() * 40) / (windSpeed > 10 ? Math.max(1.5, windSpeed/10) : 1) + 's', // WIND SPEED LOGIC
                   delay: -(Math.random() * 60) + 's' 
               }));
            }, [weatherState, skyState, windSpeed]);

            return (
                <div className={`absolute inset-0 overflow-hidden -z-0 transition-all duration-1000 ${gradients[skyState] || gradients.day} ${weatherOverlay}`}>
                    {skyState === 'night' && !weatherState.isCloudy && stars.map((s, i) => (
                        <div key={i} className="star" style={{ top: s.top, left: s.left, width: s.size, height: s.size, '--delay': s.delay, '--duration': s.duration }} />
                    ))}
                    {(!weatherState.isCloudy && !weatherState.isRainy) && (
                        <div className="absolute w-16 h-16 transition-all duration-[60000ms] ease-linear" style={{ left: `calc(${celestialPos.x}% - 2rem)`, top: `calc(${celestialPos.y}% - 2rem)` }}>
                            {skyState === 'night' ? (
                                <svg width="100%" height="100%" viewBox="0 0 100 100" className="drop-shadow-[0_0_15px_rgba(255,255,255,0.6)]">
                                    <circle cx="50" cy="50" r="40" fill="#fbbf24" opacity={moonPhase > 0.4 && moonPhase < 0.6 ? 1 : 0.2} />
                                    <path d="M50 10 A40 40 0 1 0 50 90 A 30 40 0 1 1 50 10" fill="#fef3c7" />
                                </svg>
                            ) : (
                                <div className="w-full h-full rounded-full bg-yellow-300 blur-md shadow-[0_0_40px_rgba(253,224,71,0.8)] animate-glow"></div>
                            )}
                        </div>
                    )}
                    {clouds.map((c, i) => (
                        <div key={i} className="absolute animate-float" style={{ top: c.top, width: '100px', height: '50px', animationDuration: c.duration, animationDelay: c.delay, opacity: c.opacity, transform: `scale(${c.scale})` }}>
                             <svg viewBox="0 0 100 50" className="cloud-shape" style={{ fill: weatherState.isCloudy ? 'rgba(200, 210, 220, 0.7)' : 'rgba(255, 255, 255, 0.4)' }}>
                                <path d="M10,30 Q25,10 40,30 T70,30 T90,30" stroke={weatherState.isCloudy ? '#94a3b8' : 'white'} strokeWidth="20" strokeLinecap="round" />
                             </svg>
                        </div>
                    ))}
                    {weatherState.isRainy && rainDrops.map((r, i) => (
                        <div key={i} className="raindrop" style={{ left: r.left, animationDuration: r.animationDuration, animationDelay: r.animationDelay }} />
                    ))}
                </div>
            );
        };

        // ... Header ...
        const Header = ({ activeRoute, setActiveRoute, skyState, moonPhase, userLocation, weatherState, windSpeed }) => (
            <div className="sticky top-0 z-30 bg-transparent shadow-sm">
                <div className="relative text-white p-4 pb-4 rounded-b-3xl shadow-lg overflow-hidden transition-all duration-500">
                    <SkyBackground skyState={skyState} moonPhase={moonPhase} userLocation={userLocation} weatherState={weatherState} windSpeed={windSpeed} />
                    <div className="relative z-10">
                        <div className="flex justify-between items-start mb-4">
                            <h1 className="text-xl font-bold flex items-center gap-2 drop-shadow-md">
                                <HeaderBusIcon className="w-6 h-6 text-yellow-300 drop-shadow-sm" />
                                <span>–ê–≤—Ç–æ–±—É—Å—ã Sunset Town</span>
                            </h1>
                            <div className="text-xs flex items-center gap-1 opacity-90 bg-black/20 backdrop-blur-md px-2.5 py-1 rounded-full border border-white/20 shadow-sm">
                                <span className="capitalize font-medium text-white">{
                                    skyState === 'night' ? '–ù–æ—á—å üåô' : 
                                    skyState === 'dawn' ? '–£—Ç—Ä–æ üåÖ' : 
                                    skyState === 'dusk' ? '–í–µ—á–µ—Ä üåá' : '–î–µ–Ω—å ‚òÄÔ∏è'
                                }</span>
                            </div>
                        </div>
                        <div className="flex bg-white/20 backdrop-blur-md rounded-xl p-1 gap-1 border border-white/10 shadow-inner">
                            {Object.keys(ROUTES).map(id => {
                                const route = ROUTES[id];
                                const isActive = activeRoute === Number(id);
                                return (
                                    <button
                                        key={id}
                                        onClick={() => setActiveRoute(Number(id))}
                                        className={`flex-1 py-3 px-1 text-sm font-bold rounded-lg transition-all flex items-center justify-center gap-2 ${
                                            isActive
                                            ? 'bg-yellow-400 text-slate-900 shadow-md transform scale-[1.02]'
                                            : 'text-white hover:bg-white/10'
                                        }`}
                                    >
                                        <span className={isActive ? 'text-slate-900' : 'text-white'}>{route.icon}</span>
                                        <span>{route.shortName}</span>
                                    </button>
                                );
                            })}
                        </div>
                        <div className="mt-3 text-center text-white/90 text-xs font-medium drop-shadow-md">
                            {ROUTES[activeRoute].desc}
                        </div>
                    </div>
                </div>
            </div>
        );

        // ... DirectionToggle ...
        const DirectionToggle = ({ routeData, direction, setDirection }) => {
            const isForward = direction === 'forward';
            const stops = routeData.stops.forward;
            const startPoint = stops[0].split(' ')[0];
            const endPoint = stops[stops.length - 1].split(' ')[0];
            return (
                <div className="px-4 mt-4 relative z-10">
                    <button
                        onClick={() => setDirection(isForward ? 'backward' : 'forward')}
                        className={`w-full flex items-center justify-between p-4 rounded-2xl border transition-all shadow-sm active:scale-95 duration-300 ${
                             isForward 
                             ? 'bg-white/80 dark:bg-slate-800/80 border-slate-200 dark:border-slate-700 backdrop-blur-sm' 
                             : 'bg-slate-50/80 border-slate-300 dark:bg-slate-900/80 dark:border-slate-800 backdrop-blur-sm'
                        }`}
                    >
                        <div className="flex flex-col items-start">
                            <span className="text-[10px] tracking-wider text-slate-500 dark:text-slate-400 font-bold uppercase mb-1">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</span>
                            <span className="font-bold text-lg text-slate-800 dark:text-slate-100 flex items-center gap-2 transition-colors duration-300">
                                {isForward ? "–¢–£–î–ê" : "–û–ë–†–ê–¢–ù–û"}
                            </span>
                        </div>
                        <div className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300 font-medium bg-slate-100 dark:bg-slate-700 px-3 py-2 rounded-lg max-w-[50%] overflow-hidden whitespace-nowrap transition-colors duration-300">
                           <span className="truncate">{isForward ? startPoint : endPoint}</span>
                           <ArrowIcon />
                           <span className="truncate">{isForward ? endPoint : startPoint}</span>
                        </div>
                    </button>
                </div>
            );
        };

        const NextBus = ({ schedule, currentMins, userStops, now, activeRouteData }) => {
            let targetStop = null;
            let displayTime = null;
            let timeUntilSeconds = 0;
            let isAtStop = false;

            if (userStops && userStops.length > 0) {
                // Find next bus including current minute
                for (const stop of userStops) {
                     const validRow = schedule.find(row => {
                         const timeStr = row[stop.index];
                         if (!timeStr || timeStr === "-") return false;
                         const mins = getMinutes(timeStr);
                         // Check if this bus is upcoming or currently here
                         return mins >= Math.floor(currentMins); 
                     });

                     if (validRow) {
                         targetStop = stop;
                         displayTime = validRow[stop.index];
                         
                         // Calculate exact diff
                         const [h, m] = displayTime.split(':').map(Number);
                         const targetDate = new Date(now);
                         targetDate.setHours(h, m, 0, 0);
                         
                         const diffMs = targetDate - now;
                         timeUntilSeconds = Math.floor(diffMs / 1000);
                         
                         // If between -60 and 0, it's at stop
                         if (timeUntilSeconds <= 0 && timeUntilSeconds > -60) {
                             isAtStop = true;
                         }
                         
                         break;
                     }
                }
            } else {
                const nextRow = schedule.find(row => {
                    const firstValidTime = row.find(t => t !== "-");
                    if (!firstValidTime) return false;
                    const mins = getMinutes(firstValidTime);
                    return mins >= Math.floor(currentMins);
                });
                if (nextRow) {
                    const firstIdx = nextRow.findIndex(t => t !== "-");
                    displayTime = nextRow[firstIdx];
                    const [h, m] = displayTime.split(':').map(Number);
                    const targetDate = new Date(now);
                    targetDate.setHours(h, m, 0, 0);
                    timeUntilSeconds = Math.floor((targetDate - now) / 1000);
                     if (timeUntilSeconds <= 0 && timeUntilSeconds > -60) {
                         isAtStop = true;
                     }
                }
            }

            if (!displayTime && !isAtStop) return (
                <div className="mx-4 mt-4 p-5 bg-slate-100/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl text-center text-slate-500 dark:text-slate-400 text-sm font-medium transition-colors duration-300 backdrop-blur-sm">
                    –ù–∞ —Å–µ–≥–æ–¥–Ω—è —Ä–µ–π—Å–æ–≤ –±–æ–ª—å—à–µ –Ω–µ—Ç üò¥
                </div>
            );

            // COLOR LOGIC
            const getCardStyle = (seconds, isAtStop) => {
                if (isAtStop) return 'from-rose-500 to-pink-600 animate-pulse-slow'; // Special "At Stop" color
                
                const minutes = seconds / 60;
                if (minutes >= 20) return 'from-emerald-500 to-teal-700'; // Green
                if (minutes >= 10) return 'from-yellow-500 to-amber-600'; // Yellow/Orange
                if (minutes >= 5) return 'from-orange-500 to-red-600'; // Orange/Red
                return 'from-red-600 to-rose-700'; // Red
            };

            const bgClass = getCardStyle(timeUntilSeconds, isAtStop);

            return (
                <div className={`mx-4 mt-4 bg-gradient-to-br ${bgClass} rounded-2xl p-5 text-white shadow-lg flex flex-col relative overflow-hidden transition-all duration-500 ring-1 ring-white/20`}>
                    <div className="flex justify-between items-center relative z-10 w-full h-full">
                         {isAtStop ? (
                            <div className="flex items-center justify-between w-full py-1">
                                <div className="flex flex-col items-start">
                                    <div className="text-3xl font-black uppercase tracking-tight leading-none mb-1 flex items-center gap-2 drop-shadow-md">
                                        –ê–í–¢–û–ë–£–°
                                    </div>
                                    <div className="text-lg font-bold opacity-90 leading-tight">–ù–ê –û–°–¢–ê–ù–û–í–ö–ï</div>
                                    {targetStop && <div className="mt-2 text-xs font-medium opacity-80 bg-black/20 px-3 py-1 rounded-full">{targetStop.name}</div>}
                                </div>
                                <div className="relative w-24 h-24 shrink-0 ml-2">
                                     <div className="absolute inset-0 bg-white/20 rounded-full animate-ping-slow"></div>
                                     <img src={activeRouteData.stopImage} className="w-full h-full object-cover rounded-full border-4 border-white/30 shadow-lg relative z-10" alt="Bus Stop" />
                                </div>
                            </div>
                        ) : (
                        <>
                             <div>
                                {targetStop ? (
                                    <div className="mb-3">
                                        <div className="flex items-center gap-1.5 text-white font-bold text-sm mb-1">
                                            <div className="flex items-center gap-1 drop-shadow-sm bg-black/20 px-2 py-1 rounded-lg backdrop-blur-md">
                                                <img src="https://www.dropbox.com/scl/fi/emlnigpxmj5p6k7trjlw9/Gemini_Generated_Image_iqkrgaiqkrgaiqkr-Photoroom.png?rlkey=xv8cuiifu3drj2q4jb6lt4stm&st=gry52n38&raw=1" className="w-5 h-5 object-contain" alt="Stop"/>
                                                <span>{targetStop.name} ({formatDistance(targetStop.dist)})</span>
                                            </div>
                                        </div>
                                        <div className="text-white text-xs opacity-90 font-medium ml-1">–°–ª–µ–¥—É—é—â–∏–π –∞–≤—Ç–æ–±—É—Å –ø—Ä–∏–µ–¥–µ—Ç –≤</div>
                                    </div>
                                ) : (
                                    <div className="text-white text-xs font-bold uppercase tracking-wider mb-1">–ë–ª–∏–∂–∞–π—à–∏–π —Ä–µ–π—Å</div>
                                )}
                                <div className="text-5xl font-extrabold tracking-tight leading-none mb-1 drop-shadow-md">{displayTime}</div>
                                <div className="inline-flex items-center gap-1.5 bg-white/20 backdrop-blur-md px-3 py-1 rounded-full text-xs font-medium text-white mt-2 shadow-sm border border-white/10">
                                    <HourglassIcon className="w-3 h-3" />
                                    {formatTimeLeft(timeUntilSeconds)}
                                </div>
                            </div>
                            <div className="p-3 bg-white/10 rounded-full backdrop-blur-md border border-white/10 shadow-inner">
                                <ClockIcon className="w-8 h-8 text-white" />
                            </div>
                        </>
                        )}
                    </div>
                    <div className="absolute -right-6 -bottom-8 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
                    <div className="absolute -left-6 -top-8 w-24 h-24 bg-white opacity-10 rounded-full blur-2xl"></div>
                </div>
            );
        };

        // ... ScheduleTable ...
        const ScheduleTable = ({ stops, schedule, currentMins, userStops, busImage }) => {
            const closestStopIndex = userStops && userStops.length > 0 ? userStops[0].index : -1;
            let activeBus = null;

            for (let r = 0; r < schedule.length; r++) {
                const row = schedule[r];
                let startMins = -1;
                let endMins = -1;
                for (let i = 0; i < row.length; i++) {
                    const m = getMinutes(row[i]);
                    if (m !== -1) { startMins = m; break; }
                }
                for (let i = row.length - 1; i >= 0; i--) {
                    const m = getMinutes(row[i]);
                    if (m !== -1) { endMins = m; break; }
                }
                if (startMins !== -1 && endMins !== -1) {
                    if (currentMins >= startMins && currentMins <= endMins) {
                        let currentSegmentStartIdx = -1;
                        let nextValidStopIdx = -1;
                        let isStationary = false;
                        for (let i = 0; i < row.length; i++) {
                            const m = getMinutes(row[i]);
                            if (m !== -1 && m <= currentMins) {
                                currentSegmentStartIdx = i;
                                if (m === currentMins) isStationary = true;
                            }
                        }
                        if (currentSegmentStartIdx !== -1) {
                            for (let j = currentSegmentStartIdx + 1; j < row.length; j++) {
                                const m = getMinutes(row[j]);
                                if (m !== -1) { nextValidStopIdx = j; break; }
                            }
                        }
                        let progress = 0;
                        if (currentSegmentStartIdx !== -1 && nextValidStopIdx !== -1 && !isStationary) {
                            const timeStart = getMinutes(row[currentSegmentStartIdx]);
                            const timeEnd = getMinutes(row[nextValidStopIdx]);
                            const duration = timeEnd - timeStart;
                            const elapsed = currentMins - timeStart;
                            if (duration > 0) progress = elapsed / duration;
                            else progress = 0.95; 
                        } 
                        activeBus = { rowIndex: r, stopIndex: currentSegmentStartIdx, progress: progress, isStationary: isStationary };
                        break;
                    }
                }
            }

            return (
                <div className="mt-8 pb-10 border-t border-slate-200 dark:border-slate-800 pt-6 transition-colors duration-500">
                    <h3 className="px-4 text-xs font-bold text-slate-400 dark:text-slate-500 uppercase mb-4 flex items-center gap-2">
                         <InfoIcon /> –ü–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                    </h3>
                    <div className="overflow-x-auto scrollbar-hide pb-4">
                        <table className="w-full text-sm text-left border-collapse min-w-[600px] md:min-w-full">
                            <thead className="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50/50 dark:bg-slate-800/50 border-y border-slate-200 dark:border-slate-700 transition-colors duration-300">
                                <tr>
                                    {stops.map((stop, idx) => (
                                        <th key={idx} className={`px-4 py-3 font-bold whitespace-nowrap min-w-[120px] first:pl-6 last:pr-6 ${idx === closestStopIndex ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400' : ''}`}>
                                            <div className="flex items-center gap-1">{stop} {idx === closestStopIndex && <LocationIcon className="w-3 h-3" />}</div>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {schedule.map((row, rowIdx) => {
                                    let isRowPast = false;
                                    if (closestStopIndex !== -1) {
                                        const time = row[closestStopIndex];
                                        if (time && time !== "-" && isPast(time, currentMins)) isRowPast = true;
                                        if (time === "-") isRowPast = true;
                                    } else {
                                         const firstValidTime = row.find(t => t !== "-");
                                         isRowPast = firstValidTime && isPast(firstValidTime, currentMins);
                                    }
                                    const isActiveRow = activeBus && activeBus.rowIndex === rowIdx;
                                    if (isActiveRow) isRowPast = false;

                                    return (
                                        <tr key={rowIdx} className={`border-b border-slate-100 dark:border-slate-800 last:border-0 transition-colors duration-300 ${isRowPast ? 'bg-slate-50/30 dark:bg-slate-900/30' : 'bg-white/80 dark:bg-slate-900/80'} ${isActiveRow ? 'bg-yellow-50/50 dark:bg-yellow-900/20' : ''}`}>
                                            {row.map((time, cellIdx) => {
                                                const isHighlighted = cellIdx === closestStopIndex;
                                                const showBus = activeBus && activeBus.rowIndex === rowIdx && activeBus.stopIndex === cellIdx;
                                                const isTimePast = time !== "-" && isPast(time, currentMins);
                                                
                                                let textColorClass;
                                                if (isRowPast || isTimePast) textColorClass = 'text-slate-300 dark:text-slate-600';
                                                else textColorClass = isHighlighted ? 'text-blue-700 dark:text-blue-400 font-bold' : 'text-slate-800 dark:text-slate-200 font-bold';
                                                
                                                const textZIndex = showBus && !activeBus.isStationary ? 'z-0' : 'z-10';
                                                const busZIndex = showBus && !activeBus.isStationary ? 'z-20' : 'z-0';

                                                return (
                                                    <td key={cellIdx} className={`px-4 py-3 whitespace-nowrap first:pl-6 last:pr-6 relative ${isHighlighted ? 'bg-blue-50/30 dark:bg-blue-900/20' : ''}`}>
                                                        {showBus && (
                                                            <div className={`absolute inset-y-0 left-0 w-full flex items-center overflow-visible ${busZIndex}`} style={{ pointerEvents: 'none' }}>
                                                                <div className={`absolute transition-all duration-1000 ease-linear will-change-left ${!activeBus.isStationary ? 'animate-bus' : ''}`} style={{ left: activeBus.isStationary ? '1.5rem' : `calc(1.5rem + ${activeBus.progress * 60}px)` }}>
                                                                    <img src={busImage} alt="Bus" className="h-5 w-auto drop-shadow-sm object-contain flex-shrink-0" />
                                                                </div>
                                                            </div>
                                                        )}
                                                        {time === "-" ? (
                                                            <span className="text-slate-200 dark:text-slate-700 font-light relative z-10">‚Äî</span>
                                                        ) : (
                                                            <span className={`relative inline-block ${textZIndex}`}>
                                                                {showBus && activeBus.isStationary ? (
                                                                    <span className="bg-black/50 text-white rounded px-1 py-0.5 backdrop-blur-sm font-bold">{time}</span>
                                                                ) : (
                                                                    <span className={`font-mono text-[15px] transition-colors duration-300 ${textColorClass}`}>{time}</span>
                                                                )}
                                                            </span>
                                                        )}
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    <div className="text-center text-[10px] text-slate-400 dark:text-slate-600 mt-2 px-4 flex justify-center items-center gap-2">
                         <ArrowIcon className="w-3 h-3 rotate-90" /><span>–õ–∏—Å—Ç–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ</span><ArrowIcon className="w-3 h-3 -rotate-90" />
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeRouteId, setActiveRouteId] = useState(1);
            const [direction, setDirection] = useState('forward');
            const [currentMins, setCurrentMins] = useState(getCurrentMinutesFloat());
            const [now, setNow] = useState(new Date());
            const [isDark, setIsDark] = useState(false);
            const [skyState, setSkyState] = useState('day');
            const [moonPhase, setMoonPhase] = useState(0.5);
            const [userLocation, setUserLocation] = useState(null);
            const [userStops, setUserStops] = useState(null);
            const [weatherState, setWeatherState] = useState({ isRainy: false, isCloudy: false });
            const [windSpeed, setWindSpeed] = useState(0);

            // Fetch Weather
            useEffect(() => {
                if (!userLocation) return;
                const fetchWeather = async () => {
                    try {
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${userLocation.lat}&longitude=${userLocation.lng}&current=weather_code,wind_speed_10m`);
                        const data = await response.json();
                        const code = data.current.weather_code;
                        const wind = data.current.wind_speed_10m;
                        setWindSpeed(wind);
                        const isCloudy = [1, 2, 3, 45, 48].includes(code); // STRICT WEATHER
                        const isRainy = [51, 53, 55, 56, 57, 61, 63, 65, 66, 67, 80, 81, 82, 95, 96, 99].includes(code);
                        setWeatherState({ isRainy, isCloudy });
                    } catch (e) { console.error(e); }
                };
                fetchWeather();
                const interval = setInterval(fetchWeather, 600000); 
                return () => clearInterval(interval);
            }, [userLocation]);

            // Theme & Sky
            useEffect(() => {
                const updateTheme = () => {
                    const now = new Date();
                    let currentState = 'day';
                    let isDarkTime = false;

                    if (typeof SunCalc !== 'undefined') {
                        const moon = SunCalc.getMoonIllumination(now);
                        setMoonPhase(moon.phase);
                    }

                    if (userLocation && typeof SunCalc !== 'undefined') {
                        const times = SunCalc.getTimes(now, userLocation.lat, userLocation.lng);
                        if (now < times.dawn || now > times.night) { currentState = 'night'; isDarkTime = true; }
                        else if (now < times.sunrise) { currentState = 'dawn'; isDarkTime = false; } 
                        else if (now < times.sunsetStart) { currentState = 'day'; isDarkTime = false; }
                        else if (now < times.night) { currentState = 'dusk'; isDarkTime = true; } 
                        else { currentState = 'night'; isDarkTime = true; }
                    } else {
                        const hour = now.getHours();
                        if (hour >= 20 || hour < 6) { currentState = 'night'; isDarkTime = true; }
                        else if (hour >= 6 && hour < 9) { currentState = 'dawn'; isDarkTime = false; }
                        else if (hour >= 18 && hour < 20) { currentState = 'dusk'; isDarkTime = true; }
                        else { currentState = 'day'; isDarkTime = false; }
                    }

                    setSkyState(currentState);
                    setIsDark(isDarkTime);
                    if (isDarkTime) document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                };
                updateTheme();
                const timer = setInterval(updateTheme, 60000);
                return () => clearInterval(timer);
            }, [userLocation]);

            // Timer (Update every 1s for smooth bus and accurate countdown)
            useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentMins(getCurrentMinutesFloat());
                    setNow(new Date());
                }, 1000); 
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => setUserLocation({ lat: position.coords.latitude, lng: position.coords.longitude }),
                        (error) => console.log("Geo denied")
                    );
                }
            }, []);

            useEffect(() => {
                if (!userLocation) return;
                const activeData = ROUTES[activeRouteId];
                const currentStops = activeData.stops[direction];
                const stopsWithDist = currentStops.map((stopName, index) => {
                    const coordKey = Object.keys(STOP_COORDINATES).find(key => stopName.includes(key));
                    if (coordKey) {
                        const coords = STOP_COORDINATES[coordKey];
                        const dist = calculateDistance(userLocation.lat, userLocation.lng, coords.lat, coords.lng);
                        return { name: stopName, dist: dist, index: index };
                    }
                    return null;
                }).filter(item => item !== null);
                stopsWithDist.sort((a, b) => a.dist - b.dist);
                if (stopsWithDist.length > 0 && stopsWithDist[0].dist < 15) setUserStops(stopsWithDist);
                else setUserStops(null);
            }, [userLocation, activeRouteId, direction]);

            useEffect(() => { setDirection('forward'); }, [activeRouteId]);

            const activeData = ROUTES[activeRouteId];
            const currentStops = activeData.stops[direction];
            const currentSchedule = activeData.schedule[direction];

            const globalBgClass = {
                'night': 'bg-slate-950',
                'dawn': 'bg-orange-50',
                'day': 'bg-slate-50',
                'dusk': 'bg-slate-900',
            }[skyState];

            return (
                <div className={`min-h-screen ${globalBgClass} max-w-lg mx-auto shadow-2xl md:my-10 overflow-hidden relative md:rounded-[30px] border-slate-200 dark:border-slate-800 md:border transition-colors duration-1000`}>
                    <Header activeRoute={activeRouteId} setActiveRoute={setActiveRouteId} isDark={isDark} skyState={skyState} moonPhase={moonPhase} userLocation={userLocation} weatherState={weatherState} windSpeed={windSpeed} />
                    <main>
                        <DirectionToggle routeData={activeData} direction={direction} setDirection={setDirection} />
                        {userStops && userStops.length > 0 && (
                             <div className="mx-4 mt-2 mb-1 flex items-center justify-center gap-2 text-xs text-blue-600 dark:text-blue-400 font-medium bg-blue-50/50 dark:bg-blue-900/20 py-1.5 rounded-lg border border-blue-100 dark:border-blue-800 animate-fadeIn transition-colors duration-300 backdrop-blur-sm">
                                <LocationIcon className="w-3 h-3" />
                                <span>–í—ã —Ä—è–¥–æ–º —Å: <b>{userStops[0].name}</b></span>
                            </div>
                        )}
                        <NextBus schedule={currentSchedule} currentMins={currentMins} stops={currentStops} userStops={userStops} now={now} activeRouteData={activeData} />
                        <ScheduleTable stops={currentStops} schedule={currentSchedule} currentMins={currentMins} userStops={userStops} nearestStop={userStops && userStops.length > 0 ? userStops[0].name : null} busImage={activeData.busImage} />
                    </main>
                    <footer className="text-center py-6 text-xs text-slate-300 dark:text-slate-600 border-t border-slate-100 dark:border-slate-800 transition-colors duration-500">
                        <p className="font-medium">–ü—Ä–∏—è—Ç–Ω–æ–π –ø–æ–µ–∑–¥–∫–∏! üöå</p>
                        <p className="mt-1 opacity-60 text-[10px]">by EvZem</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>